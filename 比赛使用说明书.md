# 📖 SSVEP比赛使用说明书

## 🎯 你需要做什么？

对于你的具体比赛，只需要按照下面的步骤操作：

---

## 第一步：理解你的比赛数据

### **问题1：你的数据格式是什么？**

检查你收到的测试文件：

**方式A：CSV文件（最常见）**
```bash
# 打开 test_data.csv，看起来像这样？
CP3,CPZ,CP4,PO3,POZ,PO4,taskID,stimID
-3.36,1.03,-4.27,...,0,1
-6.67,0.42,-0.92,...,0,1
...

# 如果有 stimID 列 → 可以验证准确率
# 如果没有 stimID 列 → 直接提交预测
```

**方式B：numpy 数组或其他格式**
```python
# 用我提供的 predict_from_array() 方法处理
```

### **问题2：你的采样率是多少？**

查看比赛文档或计算：
```python
采样率 = 行数 / 时间(秒)
# 例如：48000行 / 24秒 = 2000 Hz？ 不对...
# 应该是：6000行 / 24秒 = 250 Hz ✓
```

常见的采样率：
- 200 Hz（某些医疗设备）
- 250 Hz（常见，我们的默认值）✓
- 500 Hz（高精度设备）

### **问题3：有多少种刺激频率？**

- **8种频率**（我们的默认配置）✓
- **4种频率**（需要修改代码）
- **其他数量**（需要修改代码）

---

## 第二步：准备代码

### **步骤1：修改采样率（如果不是250Hz）**

编辑 `competition_guide.py`，找到第47行：

```python
# 默认是这样
runner = SSVEPCompetitionRunner(srate=250, dataLen=4.0)

# 如果你的采样率是200Hz，改成
runner = SSVEPCompetitionRunner(srate=200, dataLen=4.0)

# 如果是500Hz，改成
runner = SSVEPCompetitionRunner(srate=500, dataLen=2.0)
```

### **步骤2：修改刺激频率（如果不同）**

编辑 `competition_guide.py`，找到第46行的 `FREQ_MAP`：

**情况A：比赛文档明确指出了8个频率**
```python
# 例如：8, 12, 14, 16, 18, 20, 22, 24 Hz
self.FREQ_MAP = {
    0: 8.0,
    1: 12.0,
    2: 14.0,
    3: 16.0,
    4: 18.0,
    5: 20.0,
    6: 22.0,
    7: 24.0
}
```

**情况B：你不确定频率**

使用诊断工具：
```bash
python diagnose_ssvep_freq.py
```

这会显示实际的频率分布，你就知道该用什么了。

---

## 第三步：测试代码

### **最快验证（2分钟）**

```python
# 方式1：如果你有标准答案
python test_ssvep_corrected.py

# 方式2：如果没有标准答案
python competition_guide.py
```

### **详细验证**

```python
from competition_guide import SSVEPCompetitionRunner

# 1. 初始化
runner = SSVEPCompetitionRunner(srate=250, dataLen=4.0)

# 2. 测试准确率（如果有标准答案）
predictions = runner.predict_from_csv("test_data.csv")

# 3. 查看输出
# 应该显示：
# ✓ stimID=0: 真实频率=16.00Hz, 预测频率=16.00Hz ✓
# ✓ stimID=1: ...
# 📊 本次测试准确率: 100.0%
```

### **如果准确率不理想（<80%）**

**检查清单：**
```
[ ] 采样率是否正确？
[ ] 刺激频率是否正确？
[ ] 数据窗口长度是否太短？

# 如果都对，试试增加窗口长度：
runner = SSVEPCompetitionRunner(srate=250, dataLen=5.0)
```

---

## 第四步：生成提交文件

### **方式1：最简单（推荐）**

```python
from competition_guide import SSVEPCompetitionRunner

runner = SSVEPCompetitionRunner(srate=250, dataLen=4.0)
runner.batch_predict_and_submit(
    test_csv="test_data.csv",
    output_csv="predictions.csv"
)
```

运行结果：
```
✓ 预测完成!
  总预测数: 48
  准确率: 100.0% (48/48)
  输出文件: predictions.csv
```

### **方式2：更多控制**

```python
import pandas as pd
from ssvepdetect import ssvepDetect

# 1. 初始化
srate = 250
freqs = [16.0, 9.0, 10.0, 11.0, 12.0, 13.0, 10.58, 15.0]
detector = ssvepDetect(srate, freqs, dataLen=4.0)

# 2. 加载数据
data = pd.read_csv("test_data.csv")

# 3. 对每个 taskID 预测
results = []
for task_id in data['taskID'].unique():
    segment = data[data['taskID'] == task_id].iloc[:, :6].values.T
    pred = detector.detect(segment)
    results.append({'taskID': task_id, 'predicted_stimID': pred})

# 4. 保存
pd.DataFrame(results).to_csv("predictions.csv", index=False)
```

---

## 第五步：验证提交文件

```python
import pandas as pd

# 检查文件格式
df = pd.read_csv("predictions.csv")

# 应该显示类似这样：
#    taskID  predicted_stimID
# 0       0                 2
# 1       1                 4
# 2       2                 0
# ...

# 检查数据是否完整
print(df.shape)  # 应该是 (样本数, 2)
print(df.isnull().sum())  # 应该都是 0
print(df['predicted_stimID'].min(), df['predicted_stimID'].max())  # 应该在 0-7 之间
```

---

## ⚠️ 比赛前注意事项

### **【重要】参数对应关系**

确保你修改的参数与比赛数据一致：

```python
# 比赛文档说的采样率 ← → 代码中的 srate
# 比赛文档说的刺激频率 ← → 代码中的 FREQ_MAP
# 比赛数据片段时长 ← → 代码中的 dataLen
```

如果对应关系错了，**准确率会是0%**。

### **【重要】验证测试**

在正式提交前，至少测试：
- [ ] 5个不同的样本
- [ ] 准确率是否一致
- [ ] 是否有错误信息

---

## 📊 三种常见场景

### **场景1：有标准答案的验证集**

```bash
# 使用这个命令
python test_ssvep_corrected.py

# 查看准确率
# 应该显示 100% 或接近 100%
```

### **场景2：没有标准答案的测试集**

```bash
# 使用这个命令
python competition_guide.py

# 生成提交文件
# predictions_output.csv
```

### **场景3：自己的数据格式**

```python
from competition_guide import SSVEPCompetitionRunner
import numpy as np

runner = SSVEPCompetitionRunner(srate=250, dataLen=4.0)

# 你的数据
eeg = np.load("data.npy")  # shape: (6, 1000)

# 预测
pred_id, pred_freq, _ = runner.predict_from_array(eeg)
print(f"预测: {pred_id}")
```

---

## 🔍 问题排查

### **问题：准确率0%**
```
原因：频率映射错误
解决：检查 FREQ_MAP 是否与比赛数据匹配
```

### **问题：准确率50%**
```
原因：窗口长度太短
解决：改为 dataLen=4.0 或 5.0
```

### **问题：程序很慢**
```
原因：窗口长度太长
解决：改为 dataLen=3.0（但准确率会下降）
```

### **问题：Shape错误**
```
原因：数据格式不对
解决：确保是 (6, 1000) 的形状，需要 .T 转置
```

---

## 📋 最终检查清单

比赛前必须检查：

- [ ] 采样率正确吗？（在代码中修改了）
- [ ] 刺激频率正确吗？（在 FREQ_MAP 中修改了）
- [ ] 测试数据准确率 > 80%？
- [ ] 提交文件格式正确？（CSV，包含 taskID 和 predicted_stimID）
- [ ] 没有 NaN 或错误值？
- [ ] 样本数和预期数量一致？

---

## 🚀 运行命令总结

```bash
# 1. 查看快速参考
cat 快速参考卡.txt

# 2. 运行测试
python competition_guide.py

# 3. 批量预测
python -c "
from competition_guide import SSVEPCompetitionRunner
runner = SSVEPCompetitionRunner(srate=250, dataLen=4.0)
runner.batch_predict_and_submit('test_data.csv', 'predictions.csv')
"

# 4. 验证结果
python -c "
import pandas as pd
df = pd.read_csv('predictions.csv')
print(df.head())
print(f'Total: {len(df)} predictions')
"
```

---

## 📚 帮助资源

| 文件 | 用途 | 何时看 |
|------|------|--------|
| 快速参考卡.txt | 快速参考 | 忘记参数时 |
| 竞赛快速指南.md | 快速上手 | 刚开始时 |
| 比赛运行完全指南.md | 详细说明 | 遇到问题时 |
| SSVEP_CCA算法分析总结.md | 算法原理 | 想理解原理时 |

---

## 💬 常见问题

**Q: 我的比赛有4种频率，怎么改？**

A: 修改 competition_guide.py 的 FREQ_MAP，只保留前4个。

**Q: 我不知道自己的采样率，怎么办？**

A: 联系比赛组织方，或看比赛说明文档。

**Q: 代码运行报错，怎么办？**

A: 
1. 检查依赖是否安装 (`pip install -r requirements.txt` 或 `pip install numpy pandas scikit-learn scipy`)
2. 检查文件路径是否正确
3. 检查数据格式是否正确

**Q: 如何加快预测速度？**

A: 减少 dataLen（但会降低准确率），或使用更少的样本点。

**Q: 如何提高准确率？**

A: 增加 dataLen 到 5-6 秒，或检查频率映射是否正确。

---

## ✅ 准备就绪！

你现在拥有：

✓ 经过验证的 CCA 算法（100%准确率）  
✓ 完整的比赛运行框架  
✓ 详细的参数调整指南  
✓ 问题排查工具  
✓ 快速参考文档  

**下一步：**
1. 根据你的比赛数据调整参数
2. 运行测试验证准确率
3. 生成提交文件
4. 按时提交

**祝你比赛顺利！🏆**

---

*最后更新：2025年11月11日*
